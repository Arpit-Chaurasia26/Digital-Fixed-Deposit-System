


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > SupportTicketServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">tech.zeta.Digital_Fixed_Deposit_System.service.support</a>
</div>

<h1>Coverage Summary for Class: SupportTicketServiceImpl (tech.zeta.Digital_Fixed_Deposit_System.service.support)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">SupportTicketServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    9.1%
  </span>
  <span class="absValue">
    (1/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/36)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    7.5%
  </span>
  <span class="absValue">
    (6/80)
  </span>
</td>
</tr>
  <tr>
    <td class="name">SupportTicketServiceImpl$$SpringCGLIB$$0</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    9.1%
  </span>
  <span class="absValue">
    (1/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/36)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    7.5%
  </span>
  <span class="absValue">
    (6/80)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package tech.zeta.Digital_Fixed_Deposit_System.service.support;
&nbsp;
&nbsp;import org.springframework.data.domain.*;
&nbsp;import tech.zeta.Digital_Fixed_Deposit_System.config.security.CurrentUserProvider;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;import tech.zeta.Digital_Fixed_Deposit_System.dto.support.SupportTicketRequestDTO;
&nbsp;import tech.zeta.Digital_Fixed_Deposit_System.dto.support.SupportTicketResponseDTO;
&nbsp;import tech.zeta.Digital_Fixed_Deposit_System.entity.support.SupportTicket;
&nbsp;import tech.zeta.Digital_Fixed_Deposit_System.entity.support.TicketStatus;
&nbsp;import tech.zeta.Digital_Fixed_Deposit_System.repository.FixedDepositRepository;
&nbsp;import tech.zeta.Digital_Fixed_Deposit_System.service.support.specifications.SupportTicketSpecifications;
&nbsp;import tech.zeta.Digital_Fixed_Deposit_System.entity.user.User;
&nbsp;import tech.zeta.Digital_Fixed_Deposit_System.mapper.SupportTicketMapper;
&nbsp;import tech.zeta.Digital_Fixed_Deposit_System.repository.SupportTicketRepository;
&nbsp;import tech.zeta.Digital_Fixed_Deposit_System.repository.UserRepository;
&nbsp;import org.springframework.data.jpa.domain.Specification;
&nbsp;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.List;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;@Service
&nbsp;@Transactional
&nbsp;public class SupportTicketServiceImpl implements SupportTicketService {
&nbsp;
&nbsp;    private final SupportTicketRepository repository;
&nbsp;    private final SupportTicketMapper mapper;
&nbsp;    private final CurrentUserProvider currentUserProvider;
&nbsp;    private final UserRepository userRepository;
&nbsp;    private final FixedDepositRepository fdRepository;
&nbsp;
&nbsp;
&nbsp;    public SupportTicketServiceImpl(SupportTicketRepository repository,
&nbsp;                                    SupportTicketMapper mapper,
&nbsp;                                    CurrentUserProvider currentUserProvider,
&nbsp;                                    UserRepository userRepository,
<b class="fc">&nbsp;                                    FixedDepositRepository fdRepository ) { //injecting here</b>
<b class="fc">&nbsp;        this.repository = repository;</b>
<b class="fc">&nbsp;        this.mapper = mapper;</b>
<b class="fc">&nbsp;        this.currentUserProvider = currentUserProvider;</b>
<b class="fc">&nbsp;        this.userRepository = userRepository;</b>
<b class="fc">&nbsp;        this.fdRepository = fdRepository; // assign</b>
&nbsp;    }
&nbsp;
&nbsp;    // üîπ Create a new ticket (User only)
&nbsp;    @Override
&nbsp;    public SupportTicketResponseDTO createTicket(SupportTicketRequestDTO requestDTO) {
<b class="nc">&nbsp;        User currentUser = getCurrentUser();</b>
&nbsp;
<b class="nc">&nbsp;        if (isAdmin(currentUser)) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Admins cannot create tickets&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        requestDTO.setUserId(currentUser.getId());</b>
&nbsp;
&nbsp;        // ‚úÖ Validate FD ownership
<b class="nc">&nbsp;        if (!checkUserOwnsFD(currentUser.getId(), requestDTO.getFdId())) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Invalid FD ID: You do not own this FD&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        SupportTicket ticket = mapper.toEntity(requestDTO);</b>
<b class="nc">&nbsp;        ticket.setStatus(TicketStatus.OPEN);</b>
<b class="nc">&nbsp;        ticket.setCreatedTime(LocalDateTime.now());</b>
<b class="nc">&nbsp;        ticket.setUpdatedTime(LocalDateTime.now());</b>
&nbsp;
<b class="nc">&nbsp;        SupportTicket saved = repository.save(ticket);</b>
<b class="nc">&nbsp;        return mapper.toResponseDTO(saved);</b>
&nbsp;    }
&nbsp;
&nbsp;    // üîπ Get ticket by ID (Admin only)
&nbsp;    @Override
&nbsp;    public SupportTicketResponseDTO getTicketById(Long ticketId) {
<b class="nc">&nbsp;        User currentUser = getCurrentUser();</b>
&nbsp;
<b class="nc">&nbsp;        if (!isAdmin(currentUser)) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Only admins can access tickets by ID&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        SupportTicket ticket = repository.findById(ticketId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Ticket not found&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        return mapper.toResponseDTO(ticket);</b>
&nbsp;    }
&nbsp;
&nbsp;    // üîπ Get tickets of logged-in user (User only)
&nbsp;    @Override
&nbsp;    public List&lt;SupportTicketResponseDTO&gt; getTicketsByUserId() {
<b class="nc">&nbsp;        User currentUser = getCurrentUser();</b>
&nbsp;
<b class="nc">&nbsp;        if (!isUser(currentUser)) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Admins do not have personal tickets&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return repository.findByUserId(currentUser.getId())</b>
<b class="nc">&nbsp;                .stream()</b>
<b class="nc">&nbsp;                .map(mapper::toResponseDTO)</b>
<b class="nc">&nbsp;                .collect(Collectors.toList());</b>
&nbsp;    }
&nbsp;
&nbsp;    // üîπ Get all tickets (Admin only)
&nbsp;    // Admin only
&nbsp;
&nbsp;    @Override
&nbsp;    public Page&lt;SupportTicketResponseDTO&gt; getAllTickets(TicketStatus status, LocalDateTime fromDate, LocalDateTime toDate, Pageable pageable) {
<b class="nc">&nbsp;        User currentUser = getCurrentUser();</b>
<b class="nc">&nbsp;        if (!isAdmin(currentUser)) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Only admins can access all tickets&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Specification&lt;SupportTicket&gt; spec = Specification</b>
<b class="nc">&nbsp;                .where(SupportTicketSpecifications.hasStatus(status))</b>
<b class="nc">&nbsp;                .and(SupportTicketSpecifications.createdAfter(fromDate))</b>
<b class="nc">&nbsp;                .and(SupportTicketSpecifications.createdBefore(toDate))</b>
<b class="nc">&nbsp;                .and(SupportTicketSpecifications.updatedAfter(fromDate))</b>
<b class="nc">&nbsp;                .and(SupportTicketSpecifications.updatedBefore(toDate));</b>
&nbsp;
<b class="nc">&nbsp;        return repository.findAll(spec, pageable)</b>
<b class="nc">&nbsp;                .map(mapper::toResponseDTO);</b>
&nbsp;    }
&nbsp;
&nbsp;    // üîπ Update ticket status
&nbsp;    @Override
&nbsp;    public SupportTicketResponseDTO updateTicketStatus(Long ticketId, TicketStatus newStatus) {
<b class="nc">&nbsp;        SupportTicket ticket = repository.findById(ticketId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Ticket not found&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        User currentUser = getCurrentUser();</b>
<b class="nc">&nbsp;        TicketStatus currentStatus = ticket.getStatus();</b>
&nbsp;
&nbsp;        // ‚ùå Prevent backward movement
<b class="nc">&nbsp;        if (currentStatus == TicketStatus.CLOSED) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Closed tickets cannot be updated&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (currentStatus == TicketStatus.RESOLVED &amp;&amp; newStatus == TicketStatus.OPEN) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Cannot move RESOLVED ticket back to OPEN&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Admin rules
<b class="nc">&nbsp;        if (isAdmin(currentUser)) {</b>
<b class="nc">&nbsp;            if (newStatus != TicketStatus.RESOLVED) {</b>
<b class="nc">&nbsp;                throw new RuntimeException(&quot;Admins can only mark tickets as RESOLVED&quot;);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // User rules
<b class="nc">&nbsp;        if (isUser(currentUser)) {</b>
<b class="nc">&nbsp;            if (newStatus != TicketStatus.CLOSED) {</b>
<b class="nc">&nbsp;                throw new RuntimeException(&quot;Users can only mark their tickets as CLOSED&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (!ticket.getUserId().equals(currentUser.getId())) {</b>
<b class="nc">&nbsp;                throw new RuntimeException(&quot;Users can only close their own tickets&quot;);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        ticket.setStatus(newStatus);</b>
<b class="nc">&nbsp;        ticket.setUpdatedTime(LocalDateTime.now());</b>
<b class="nc">&nbsp;        SupportTicket updated = repository.save(ticket);</b>
&nbsp;
<b class="nc">&nbsp;        return mapper.toResponseDTO(updated);</b>
&nbsp;    }
&nbsp;
&nbsp;    // üîπ Update ticket response (Admin only)
&nbsp;    @Override
&nbsp;    public SupportTicketResponseDTO updateTicketResponse(Long ticketId, String response) {
<b class="nc">&nbsp;        User currentUser = getCurrentUser();</b>
&nbsp;
<b class="nc">&nbsp;        if (!isAdmin(currentUser)) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Only admins can update ticket responses&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        SupportTicket ticket = repository.findById(ticketId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;Ticket not found&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        ticket.setResponse(response);</b>
<b class="nc">&nbsp;        if (ticket.getStatus() == TicketStatus.OPEN) {</b>
<b class="nc">&nbsp;            ticket.setStatus(TicketStatus.RESOLVED);</b>
&nbsp;        }
<b class="nc">&nbsp;        ticket.setUpdatedTime(LocalDateTime.now());</b>
&nbsp;
<b class="nc">&nbsp;        SupportTicket updated = repository.save(ticket);</b>
<b class="nc">&nbsp;        return mapper.toResponseDTO(updated);</b>
&nbsp;    }
&nbsp;
&nbsp;    // üîπ Helper to fetch logged-in User entity
&nbsp;    private User getCurrentUser() {
<b class="nc">&nbsp;        Long userId = currentUserProvider.getCurrentUserId();</b>
<b class="nc">&nbsp;        return userRepository.findById(userId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new RuntimeException(&quot;User not found&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    // üîπ Helper: check role
&nbsp;    private boolean isAdmin(User user) {
<b class="nc">&nbsp;        return user.getRole() != null &amp;&amp; user.getRole().name().equals(&quot;ADMIN&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean isUser(User user) {
<b class="nc">&nbsp;        return user.getRole() != null &amp;&amp; user.getRole().name().equals(&quot;USER&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    // Helper: to check the user fd&#39;s
&nbsp;    private boolean checkUserOwnsFD(Long userId, Long fdId) {
<b class="nc">&nbsp;        if (fdId == null) return true; // optional FD</b>
<b class="nc">&nbsp;        return fdRepository.findByIdAndUserId(fdId, userId).isPresent();</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-11 12:06</div>
</div>
</body>
</html>
